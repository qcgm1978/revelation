import{g as I}from"./index-fn7NKjN7.js";var E={};const w="https://api.openai.com/v1/chat/completions",O="gpt-3.5-turbo";function N(){if(typeof window<"u"&&window.localStorage){const o=localStorage.getItem("OPENAI_API_KEY");if(o)return o}if(typeof process<"u"&&E)return E.OPENAI_API_KEY}async function*k(o,n="zh",h,A){var d,f,l,u;const a=N();let e="";if(!a){yield"Error: OPENAI_API_KEY is not configured. Please configure your API key in the settings to continue.";return}const g=I(o,n,h,A);try{const t=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({model:O,messages:[{role:"user",content:g}],stream:!0,max_tokens:1e3,temperature:.7,top_p:.95})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const r=(d=t.body)==null?void 0:d.getReader();if(!r)throw new Error("Response body is not readable");const s=new TextDecoder;let i="";try{for(;;){const{done:m,value:_}=await r.read();if(m)break;i+=s.decode(_,{stream:!0});const p=i.split(`
`);i=p.pop()||"";for(const y of p)if(y.startsWith("data: ")){const P=y.slice(6);if(P==="[DONE]"){e&&(yield e,e="");return}try{const c=JSON.parse(P);(u=(l=(f=c.choices)==null?void 0:f[0])==null?void 0:l.delta)!=null&&u.content&&(e+=c.choices[0].delta.content,e.length>=40&&(yield e,e=""))}catch{}}}}finally{e&&(yield e),r.releaseLock()}}catch(t){e&&(yield e),console.error("Error streaming from OpenAI:",t);const r=n==="zh"?"请配置有效的OPENAI_API_KEY或检查VPN设置":"Please configure a valid OPENAI_API_KEY or check your VPN settings",s=`Error: ${t instanceof Error?t.message:"An unknown error occurred."}. ${r}`;throw new Error(s)}}export{k as streamDefinition};
