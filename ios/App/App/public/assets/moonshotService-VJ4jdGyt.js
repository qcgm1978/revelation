import{g as k}from"./index-fn7NKjN7.js";async function*O(y,n="zh",g,A){var p,l;try{const o=k(y,n,g,A),t=localStorage.getItem("MOONSHOT_API_KEY")||"";if(!t.trim())throw new Error("Moonshot API key is not set");const s="https://api.moonshot.cn/v1/chat/completions",c={"Content-Type":"application/json",Authorization:`Bearer ${t}`},P=JSON.stringify({model:"moonshot-v1-8k",messages:[{role:"user",content:o}],max_tokens:2e3,stream:!0}),i=await fetch(s,{method:"POST",headers:c,body:P});if(!i.ok)throw new Error(await i.json().then(h=>{var r;return((r=h.error)==null?void 0:r.message)||"Moonshot API request failed"}));const m=(p=i.body)==null?void 0:p.getReader();if(!m)throw new Error("No response body");const E=new TextDecoder;let a="";for(;;){const{done:h,value:r}=await m.read();if(h)break;const M=E.decode(r,{stream:!0});a+=M;const f=a.split(`
`);a=f.pop()||"";for(const d of f)if(d.trim()!==""&&d.startsWith("data: ")){const w=d.substring(5).trim();if(w==="[DONE]")continue;try{const e=JSON.parse(w);if(e.choices&&e.choices.length>0){const u=((l=e.choices[0].delta)==null?void 0:l.content)||"";u&&(yield u)}}catch(e){console.error("Failed to parse Moonshot API response:",e)}}}}catch(o){console.error("Moonshot service error:",o);const t=o instanceof Error?o.message:"An unknown error occurred",s=n==="zh"?"发生错误: ":"Error: ",c=n==="zh"?"请配置有效的Moonshot API Key":"Please configure valid Moonshot API Key";throw new Error(`${s}${t}. ${c}`)}}export{O as streamDefinition};
