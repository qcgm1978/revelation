import{g as V}from"./index-fn7NKjN7.js";const N="%[a-f0-9]{2}",I=new RegExp("("+N+")|([^%]+?)","gi"),R=new RegExp("("+N+")+","gi");function S(e,t){try{return[decodeURIComponent(e.join(""))]}catch{}if(e.length===1)return e;t=t||1;const r=e.slice(0,t),n=e.slice(t);return Array.prototype.concat.call([],S(r),S(n))}function M(e){try{return decodeURIComponent(e)}catch{let t=e.match(I)||[];for(let r=1;r<t.length;r++)e=S(t,r).join(""),t=e.match(I)||[];return e}}function G(e){const t={"%FE%FF":"��","%FF%FE":"��"};let r=R.exec(e);for(;r;){try{t[r[0]]=decodeURIComponent(r[0])}catch{const s=M(r[0]);s!==r[0]&&(t[r[0]]=s)}r=R.exec(e)}t["%C2"]="�";const n=Object.keys(t);for(const s of n)e=e.replace(new RegExp(s,"g"),t[s]);return e}function z(e){if(typeof e!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof e+"`");try{return decodeURIComponent(e)}catch{return G(e)}}function B(e,t){const r={};if(Array.isArray(t))for(const n of t){const s=Object.getOwnPropertyDescriptor(e,n);s!=null&&s.enumerable&&Object.defineProperty(r,n,s)}else for(const n of Reflect.ownKeys(e)){const s=Object.getOwnPropertyDescriptor(e,n);if(s.enumerable){const a=e[n];t(n,a,e)&&Object.defineProperty(r,n,s)}}return r}function A(e,t){if(!(typeof e=="string"&&typeof t=="string"))throw new TypeError("Expected the arguments to be of type `string`");if(e===""||t==="")return[];const r=e.indexOf(t);return r===-1?[]:[e.slice(0,r),e.slice(r+t.length)]}const K=e=>e==null,X=e=>encodeURIComponent(e).replaceAll(/[!'()*]/g,t=>`%${t.charCodeAt(0).toString(16).toUpperCase()}`),p=Symbol("encodeFragmentIdentifier");function Y(e){switch(e.arrayFormat){case"index":return t=>(r,n)=>{const s=r.length;return n===void 0||e.skipNull&&n===null||e.skipEmptyString&&n===""?r:n===null?[...r,[h(t,e),"[",s,"]"].join("")]:[...r,[h(t,e),"[",h(s,e),"]=",h(n,e)].join("")]};case"bracket":return t=>(r,n)=>n===void 0||e.skipNull&&n===null||e.skipEmptyString&&n===""?r:n===null?[...r,[h(t,e),"[]"].join("")]:[...r,[h(t,e),"[]=",h(n,e)].join("")];case"colon-list-separator":return t=>(r,n)=>n===void 0||e.skipNull&&n===null||e.skipEmptyString&&n===""?r:n===null?[...r,[h(t,e),":list="].join("")]:[...r,[h(t,e),":list=",h(n,e)].join("")];case"comma":case"separator":case"bracket-separator":{const t=e.arrayFormat==="bracket-separator"?"[]=":"=";return r=>(n,s)=>s===void 0||e.skipNull&&s===null||e.skipEmptyString&&s===""?n:(s=s===null?"":s,n.length===0?[[h(r,e),t,h(s,e)].join("")]:[[n,h(s,e)].join(e.arrayFormatSeparator)])}default:return t=>(r,n)=>n===void 0||e.skipNull&&n===null||e.skipEmptyString&&n===""?r:n===null?[...r,h(t,e)]:[...r,[h(t,e),"=",h(n,e)].join("")]}}function Z(e){let t;switch(e.arrayFormat){case"index":return(r,n,s)=>{if(t=/\[(\d*)]$/.exec(r),r=r.replace(/\[\d*]$/,""),!t){s[r]=n;return}s[r]===void 0&&(s[r]={}),s[r][t[1]]=n};case"bracket":return(r,n,s)=>{if(t=/(\[])$/.exec(r),r=r.replace(/\[]$/,""),!t){s[r]=n;return}if(s[r]===void 0){s[r]=[n];return}s[r]=[...s[r],n]};case"colon-list-separator":return(r,n,s)=>{if(t=/(:list)$/.exec(r),r=r.replace(/:list$/,""),!t){s[r]=n;return}if(s[r]===void 0){s[r]=[n];return}s[r]=[...s[r],n]};case"comma":case"separator":return(r,n,s)=>{const i=typeof n=="string"&&n.includes(e.arrayFormatSeparator)?n.split(e.arrayFormatSeparator).map(c=>l(c,e)):n===null?n:l(n,e);s[r]=i};case"bracket-separator":return(r,n,s)=>{const a=/(\[])$/.test(r);if(r=r.replace(/\[]$/,""),!a){s[r]=n&&l(n,e);return}const i=n===null?[]:l(n,e).split(e.arrayFormatSeparator);if(s[r]===void 0){s[r]=i;return}s[r]=[...s[r],...i]};default:return(r,n,s)=>{if(s[r]===void 0){s[r]=n;return}s[r]=[...[s[r]].flat(),n]}}}function T(e){if(typeof e!="string"||e.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function h(e,t){return t.encode?t.strict?X(e):encodeURIComponent(e):e}function l(e,t){return t.decode?z(e):e}function _(e){return Array.isArray(e)?e.sort():typeof e=="object"?_(Object.keys(e)).sort((t,r)=>Number(t)-Number(r)).map(t=>e[t]):e}function D(e){const t=e.indexOf("#");return t!==-1&&(e=e.slice(0,t)),e}function J(e){let t="";const r=e.indexOf("#");return r!==-1&&(t=e.slice(r)),t}function O(e,t,r){return r==="string"&&typeof e=="string"?e:typeof r=="function"&&typeof e=="string"?r(e):r==="boolean"&&e===null?!0:r==="boolean"&&e!==null&&(e.toLowerCase()==="true"||e.toLowerCase()==="false")?e.toLowerCase()==="true":r==="boolean"&&e!==null&&(e.toLowerCase()==="1"||e.toLowerCase()==="0")?e.toLowerCase()==="1":r==="string[]"&&t.arrayFormat!=="none"&&typeof e=="string"?[e]:r==="number[]"&&t.arrayFormat!=="none"&&!Number.isNaN(Number(e))&&typeof e=="string"&&e.trim()!==""?[Number(e)]:r==="number"&&!Number.isNaN(Number(e))&&typeof e=="string"&&e.trim()!==""?Number(e):t.parseBooleans&&e!==null&&(e.toLowerCase()==="true"||e.toLowerCase()==="false")?e.toLowerCase()==="true":t.parseNumbers&&!Number.isNaN(Number(e))&&typeof e=="string"&&e.trim()!==""?Number(e):e}function w(e){e=D(e);const t=e.indexOf("?");return t===-1?"":e.slice(t+1)}function F(e,t){t={decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1,types:Object.create(null),...t},T(t.arrayFormatSeparator);const r=Z(t),n=Object.create(null);if(typeof e!="string"||(e=e.trim().replace(/^[?#&]/,""),!e))return n;for(const s of e.split("&")){if(s==="")continue;const a=t.decode?s.replaceAll("+"," "):s;let[i,c]=A(a,"=");i===void 0&&(i=a),c=c===void 0?null:["comma","separator","bracket-separator"].includes(t.arrayFormat)?c:l(c,t),r(l(i,t),c,n)}for(const[s,a]of Object.entries(n))if(typeof a=="object"&&a!==null&&t.types[s]!=="string")for(const[i,c]of Object.entries(a)){const o=t.types[s],u=typeof o=="function"?o:o?o.replace("[]",""):void 0;a[i]=O(c,t,u)}else typeof a=="object"&&a!==null&&t.types[s]==="string"?n[s]=Object.values(a).join(t.arrayFormatSeparator):n[s]=O(a,t,t.types[s]);return t.sort===!1?n:(t.sort===!0?Object.keys(n).sort():Object.keys(n).sort(t.sort)).reduce((s,a)=>{const i=n[a];return s[a]=i&&typeof i=="object"&&!Array.isArray(i)?_(i):i,s},Object.create(null))}function P(e,t){if(!e)return"";t={encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:",",...t},T(t.arrayFormatSeparator);const r=i=>t.skipNull&&K(e[i])||t.skipEmptyString&&e[i]==="",n=Y(t),s={};for(const[i,c]of Object.entries(e))r(i)||(s[i]=c);const a=Object.keys(s);return t.sort!==!1&&a.sort(t.sort),a.map(i=>{let c=e[i];if(t.replacer&&(c=t.replacer(i,c),c===void 0)||c===void 0)return"";if(c===null)return h(i,t);if(Array.isArray(c)){if(c.length===0&&t.arrayFormat==="bracket-separator")return h(i,t)+"[]";let o=c;return t.replacer&&(o=c.map((u,m)=>t.replacer(`${i}[${m}]`,u)).filter(u=>u!==void 0)),o.reduce(n(i),[]).join("&")}return h(i,t)+"="+h(c,t)}).filter(i=>i.length>0).join("&")}function j(e,t){var s;t={decode:!0,...t};let[r,n]=A(e,"#");return r===void 0&&(r=e),{url:((s=r==null?void 0:r.split("?"))==null?void 0:s[0])??"",query:F(w(e),t),...t&&t.parseFragmentIdentifier&&n?{fragmentIdentifier:l(n,t)}:{}}}function U(e,t){t={encode:!0,strict:!0,[p]:!0,...t};const r=D(e.url).split("?")[0]||"",n=w(e.url),s={...F(n,{sort:!1,...t}),...e.query};let a=P(s,t);a&&(a=`?${a}`);let i=J(e.url);if(typeof e.fragmentIdentifier=="string"){const c=new URL(r);c.hash=e.fragmentIdentifier,i=t[p]?c.hash:`#${e.fragmentIdentifier}`}return`${r}${a}${i}`}function $(e,t,r){r={parseFragmentIdentifier:!0,[p]:!1,...r};const{url:n,query:s,fragmentIdentifier:a}=j(e,r);return U({url:n,query:B(s,t),fragmentIdentifier:a},r)}function Q(e,t,r){const n=Array.isArray(t)?s=>!t.includes(s):(s,a)=>!t(s,a);return $(e,n,r)}const W=Object.freeze(Object.defineProperty({__proto__:null,exclude:Q,extract:w,parse:F,parseUrl:j,pick:$,stringify:P,stringifyUrl:U},Symbol.toStringTag,{value:"Module"}));var f=function(e,t){if(!(this instanceof f))return new f(e,t);this.url=e,t=t||{},this.headers=t.headers||{},this.payload=t.payload!==void 0?t.payload:"",this.method=t.method||this.payload&&"POST"||"GET",this.withCredentials=!!t.withCredentials,this.debug=!!t.debug,this.autoReconnect=t.autoReconnect!==void 0?t.autoReconnect:!1,this.reconnectDelay=t.reconnectDelay!==void 0?t.reconnectDelay:3e3,this.maxRetries=t.maxRetries!==void 0?t.maxRetries:null,this.retryCount=0,this.reconnectTimer=null,this.useLastEventId=t.useLastEventId!==void 0?t.useLastEventId:!0,this.FIELD_SEPARATOR=":",this.listeners={},this.xhr=null,this.readyState=f.INITIALIZING,this.progress=0,this.chunk="",this.lastEventId="",this.addEventListener=function(r,n){this.listeners[r]===void 0&&(this.listeners[r]=[]),this.listeners[r].indexOf(n)===-1&&this.listeners[r].push(n)},this.removeEventListener=function(r,n){if(this.listeners[r]===void 0)return;const s=[];this.listeners[r].forEach(function(a){a!==n&&s.push(a)}),s.length===0?delete this.listeners[r]:this.listeners[r]=s},this.dispatchEvent=function(r){if(!r)return!0;this.debug&&console.debug(r),r.source=this;const n="on"+r.type;return this.hasOwnProperty(n)&&(this[n].call(this,r),r.defaultPrevented)?!1:this.listeners[r.type]?this.listeners[r.type].every(function(s){return s(r),!r.defaultPrevented}):!0},this._markClosed=function(){if(this.xhr=null,this.progress=0,this.chunk="",this._setReadyState(f.CLOSED),this.autoReconnect){if(this.maxRetries!==null&&this.retryCount>=this.maxRetries){this.debug&&console.debug(`SSE max retries (${this.maxRetries}) reached, stopping reconnection attempts`),this.autoReconnect=!1,this.close();return}this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.debug&&console.debug(`SSE will attempt to reconnect in ${this.reconnectDelay}ms (attempt ${this.retryCount+1}${this.maxRetries?"/"+this.maxRetries:""})`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,this.retryCount++,this.stream()},this.reconnectDelay)}},this._setReadyState=function(r){const n=new CustomEvent("readystatechange");n.readyState=r,this.readyState=r,this.dispatchEvent(n)},this._onStreamFailure=function(r){const n=new CustomEvent("error");n.responseCode=r.currentTarget.status,n.data=r.currentTarget.response,this.dispatchEvent(n),this._markClosed()},this._onStreamAbort=function(){this.dispatchEvent(new CustomEvent("abort")),this._markClosed()},this._onStreamProgress=function(r){if(!this.xhr)return;if(this.xhr.status<200||this.xhr.status>=300){this._onStreamFailure(r);return}this.retryCount=0;const n=this.xhr.responseText.substring(this.progress);this.progress+=n.length;const s=(this.chunk+n).split(/(\r\n\r\n|\r\r|\n\n)/g),a=s.pop();s.forEach((function(i){i.trim().length>0&&this.dispatchEvent(this._parseEventChunk(i))}).bind(this)),this.chunk=a},this._onStreamLoaded=function(r){this._onStreamProgress(r),this.dispatchEvent(this._parseEventChunk(this.chunk)),this.chunk="",this._markClosed()},this._parseEventChunk=function(r){if(!r||r.length===0)return null;this.debug&&console.debug(r);const n={id:null,retry:null,data:null,event:null};if(r.split(/\n|\r\n|\r/).forEach((function(a){const i=a.indexOf(this.FIELD_SEPARATOR);let c,o;if(i>0){const u=a[i+1]===" "?2:1;c=a.substring(0,i),o=a.substring(i+u)}else if(i<0)c=a,o="";else return;c in n&&(c==="data"&&n[c]!==null?n.data+=`
`+o:n[c]=o)}).bind(this)),n.data===null)return null;n.id!==null&&(this.lastEventId=n.id);const s=new CustomEvent(n.event||"message");return s.id=n.id,s.data=n.data||"",s.lastEventId=this.lastEventId,s},this._onReadyStateChange=function(){if(this.xhr&&this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED){const r={},n=this.xhr.getAllResponseHeaders().trim().split(`\r
`);for(const a of n){const[i,...c]=a.split(":"),o=c.join(":").trim();r[i.trim().toLowerCase()]=r[i.trim().toLowerCase()]||[],r[i.trim().toLowerCase()].push(o)}const s=new CustomEvent("open");s.responseCode=this.xhr.status,s.headers=r,this.dispatchEvent(s),this._setReadyState(f.OPEN)}},this.stream=function(){if(!this.xhr){this._setReadyState(f.CONNECTING),this.xhr=new XMLHttpRequest,this.xhr.addEventListener("progress",this._onStreamProgress.bind(this)),this.xhr.addEventListener("load",this._onStreamLoaded.bind(this)),this.xhr.addEventListener("readystatechange",this._onReadyStateChange.bind(this)),this.xhr.addEventListener("error",this._onStreamFailure.bind(this)),this.xhr.addEventListener("abort",this._onStreamAbort.bind(this)),this.xhr.open(this.method,this.url);for(let r in this.headers)this.xhr.setRequestHeader(r,this.headers[r]);this.useLastEventId&&this.lastEventId.length>0&&this.xhr.setRequestHeader("Last-Event-ID",this.lastEventId),this.xhr.withCredentials=this.withCredentials,this.xhr.send(this.payload)}},this.close=function(){this.readyState!==f.CLOSED&&(this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.autoReconnect=!1,this.xhr.abort())},(t.start===void 0||t.start)&&this.stream()};f.INITIALIZING=-1;f.CONNECTING=0;f.OPEN=1;f.CLOSED=2;typeof exports<"u"&&(exports.SSE=f);const d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).slice(1));function v(e,t=0){return(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase()}let C;const ee=new Uint8Array(16);function te(){if(!C){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");C=crypto.getRandomValues.bind(crypto)}return C(ee)}const re=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),L={randomUUID:re};function ne(e,t,r){var s;e=e||{};const n=e.random??((s=e.rng)==null?void 0:s.call(e))??te();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,v(n)}function se(e,t,r){return L.randomUUID&&!e?L.randomUUID():ne(e)}const ie="https://you.com/api/streamingSearch";let H={chatId:se(),chatHistory:[]};function ae(){return H}function ce(e){H=e}let oe=!1;async function*de(e,t="zh",r,n){const s=V(e,t,r,n),a=ae();let i="";try{const c=[];let o=!1,u=null,m=null;const k=new Promise(b=>{u=b;try{const x={accept:"text/event-stream"},q={q:s,domain:"youchat",chatId:a.chatId,queryTraceId:a.chatId},y=new f(`${ie}?${W.stringify(q)}`,{headers:x,withCredentials:!1});y.addEventListener("youChatToken",g=>{try{const E=JSON.parse(g.data);E.youChatToken&&(i+=E.youChatToken,c.push(E.youChatToken))}catch{}}),y.addEventListener("done",()=>{ce({chatId:a.chatId,chatHistory:[...a.chatHistory,{question:s,answer:i}]}),o=!0,u&&u()}),y.addEventListener("error",g=>{console.error(g),m=g,o=!0,u&&u()}),y.stream()}catch(x){m=x,o=!0,u&&u()}});for(;!o||c.length>0;)c.length>0?yield c.shift():await new Promise(b=>setTimeout(b,50));if(await k,m)throw m}catch(c){console.error("Error streaming from YouChat:",c);const o=t==="zh"?"网络错误，请开启或检查VPN设置":"Please check your network connection or try enabling VPN";throw new Error(`${o}`)}}export{de as streamDefinition};
